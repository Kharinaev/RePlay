variables:
  FF_ENABLE_JOB_CLEANUP: 1

#cache:
#  paths:
#    - ./venv/

stages:
  - build
  - code_quality
  - docs
  - test
  - cleanup

build-job:
  stage: build
  script:
    - python3 --version
    - python3 -m venv venv
    - source ./venv/bin/activate
    - pip install --upgrade pip wheel poetry
    - source ./venv/bin/activate
    - yes | poetry cache clear pypi --all
    - poetry update
    - poetry install
    - echo "Build complete"

pylint-job:
  stage: code_quality
  script:
    - source ./venv/bin/activate
    - pip -V
    - pip install --upgrade pylint
    - pylint --rcfile=.pylintrc replay

pycodestyle-job:
  stage: code_quality
  script:
    - source ./venv/bin/activate
    - pip install --upgrade pycodestyle
    - pycodestyle --ignore=E203,E231,E501,W503,W605 --max-doc-length=160 replay tests

sphinx-job:
  stage: docs
  script:
    - source ./venv/bin/activate
    - pip install --upgrade sphinx
    - cd docs
    - make clean html

test-job:
  stage: test
  script:
    - source ./venv/bin/activate
    - pytest --cov=replay --cov-report=term-missing --doctest-modules replay --cov-fail-under=93 tests

#cleanup_job:
#  stage: cleanup
#  script:
#    - echo "Cleaning up"
#    - rm -rf "%CACHE_PATH%/%CI_PIPELINE_ID%"
#  when: always
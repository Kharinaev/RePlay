cache:
  paths:
    - venv/

stages:
  - preliminary
  - code_quality
  - docs
  - build
  - test
  - deploy

preliminary-job:
  stage: preliminary
  script:
    - python3 --version
    - python3 -m venv venv
    - source ./venv/bin/activate
    - pip install --upgrade pip wheel poetry

pylint-job:
  stage: code_quality
  script:
    - pip -V
    - source ./venv/bin/activate
    - pip -V
    - pip install --upgrade pylint
    - pylint --rcfile=.pylintrc replay

pycodestyle-job:
  stage: code_quality
  script:
    - source ./venv/bin/activate
    - pip install --upgrade pycodestyle
    - pycodestyle --ignore=E203,E231,E501,W503,W605 --max-doc-length=160 replay tests

sphinx-job:
  stage: docs
  script:
    - source ./venv/bin/activate
    - pip install --upgrade sphinx
    - cd docs
    - make clean html

build-job:
  stage: build
  script:
    - source ./venv/bin/activate
    - poetry cache clear pypi --all
    - poetry update
    - poetry install
    - echo "Build complete"

test-job:
  stage: test
  script:
    - source ./venv/bin/activate
    - pytest --cov=replay --cov-report=term-missing --doctest-modules replay --cov-fail-under=93 tests